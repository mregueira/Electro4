\documentclass[e4_tp2_main.tex]{subfiles}
\begin{document}
\newgeometry{top=2.5cm, bottom=2.0cm, left=2.25cm, right=2.25cm}

\section{Modulación PWM y realimentación}

\subsection{Amplificador de error}

\subsubsection*{a) Valores de $R2$ y $R3$ si $V_o=25 VDC$}

Como $V_{FB}$ es el divisor de tensi\'on de $V_o$ y se busca cumplir $V_{FB}=V_{REF}$, se obtiene:

\begin{equation}
V_{FB}=V_{REF}= V_o \cdot \frac{R_3}{R_2+R_3} 
\label{ec1.1.a1}
\end{equation}


Depejando de la ecuaci\'on \eqref{ec1.1.a1} y suponiendo que $R_3=10k \Omega $, obtenemos:

\begin{equation}
R_2=R_3 \cdot \left( \frac{V_o}{V_{REF}} - 1 \right)=90k \Omega \label{ec1.1.a2}
\end{equation}

\subsubsection*{b) Transferencia  $\frac{ \widetilde{v_c}(s)}{\widetilde{v_o}(s)}$ para pequeñas variaciones} 

La transferencia a pequeñas variaciones del amplificador de error se obtiene analizando el inversor con $Z_1=R_2$ y $Z_2=R_6 + \frac{1}{sC}$. Esto se debe a que a pequeñas variaciones, tanto la fuente de tensi\'on $V_2$ como la funete de corriente $I_1$ se pasivan.

\begin{equation}
\frac{\widetilde{v_c}(s)}{\widetilde{v_o}(s)}=-\frac{R_6 + \frac{1}{s \cdot C_2} }{R_2}  \label{ec1.1.b}
\end{equation}

\subsubsection*{c) Amplificador de error como bloque de un sistema LTI. Ganancia, Polos y Ceros}

Reacomodando la ecuaci\'on \eqref{ec1.1.b}, el diagrama en bloque resulta: 

\begin{center}
\begin{tikzpicture}[
squarednode/.style={rectangle, draw=black, fill=white!5,thick, minimum size=15mm},
]
\draw[thick] (-3,0) node[above] {$V_{o}$} -- (3,0) node[above] {$V_{control}$};
\node[squarednode]      (maintopic) {\LARGE {$- \frac{R_6}{R_2} \cdot \frac{s+\frac{1}{C_2 \cdot R_6}}{s}$}};
\end{tikzpicture}
\end{center}


El amplificador de error cuenta con una ganacia $G_{amp}=\frac{R_6}{R_2} =\frac{1}{9}$, un polo en $f_p=\frac{1}{2 \pi \cdot C_2 \cdot R_6 }=159.15Hz$ y un cero en el origen.


\subsubsection*{d) Conjunto fuente de corriente I1 y R7}
La fuente de corriente $I_1$ genera sobre la resistencia $R_7$ una ca\'ida de tensi\'on que marca el punto de operaci\'on con que queremos trabajar. En el caso del circuito que estamos analizando, esa tensi\'on es $V_{control}=10k\Omega \cdot 1mA =10V$. 

Cuando se compara $V_{FB}$ con $V_{REF}$ a la entrada del amplificador de error, se obtiene una diferencia. Dicha diferencia es la que nos determina cu\'anto nos movemos del punto de operaci\'on antes mencionado. Se trabaja alrededor de ese punto porque es el que nos determina el duty requerido a la salida.

\subsection{Modulaci\'on PWM}


\subsubsection*{a) Caracter\'isticas de la se\~nal triangular}
Como podemos observar, la señal triangular que se le inserta en el terminal negativo al amplificador U1 es una señal triangular con un período de 20 $\mu $s (50kHz) y una tensión pico $V_p=19 V$. Posee un tiempo de rise $t_r=19 \mu s$ y un tiempo de caída $t_f=500ns$. Con estos valores, podemos establecer que tiene un duty cicle de: $d_t= \frac{t_r}{T}=0.95$. 
\begin{figure}[H]
\centering
\includegraphics[width=0.4\linewidth]{Imagenes/Punto1/triang_shape.png}
\caption{Señal triangular.}
\end{figure}

\subsubsection*{b) Duty cycle m\'aximo}
Para obtener el duty cycle máximo que puede obtener CompOut, debemos primero calcular la tensión de la señal triangular en el tiempo. Dicha tensión se puede expresar de la siguiente manera:
\begin{equation}
V_{Triang}(t)= \frac{V_{max_{Triang}}}{T_s} \cdot t
\end{equation} 
Sabiendo que el duty cycle es $ d=\frac{t}{T_s}$  , y que el máximo duty se da cuando la tensión de la señal triangular es igual a la tensión de saturación del amplificador, por lo que la ecuación queda de la siguiente manera:
\begin{equation}
V_{sat_{Opamp}}= d \cdot V_{maxtriang} \Rightarrow d= \frac{V_{sat_{Opamp}}}{V_{max_{Triang}}}=\frac{15 V}{19V}=0.79
\end{equation}
\subsubsection*{c) Modulador PWM como bloque de un sistema LTI.}
Para modelar el PWM como un bloque de un sistema LTI, primero debemos hallar su transferencia $\frac{d}{V_{ComOut}}$. Partiendo de la ecuación previa de la diente de sierra, podemos despejar el tiempo y, dividiendo por el período de la señal, encontramos la siguiente transferencia:
\begin{equation}
\frac{d}{V_{control}}=\frac{1}{V_{max_{Triang}}}=\frac{1}{19}
\end{equation} 

De esta forma, el bloque queda conformado de la siguiente forma:

\begin{center}
\begin{tikzpicture}[
squarednode/.style={rectangle, draw=black, fill=white!5,thick, minimum size=10mm},
]
\draw[thick] (-2,0)  node[above] {$V_{control}$} -- (2,0) node[above] {$d$};

\node[squarednode]      (maintopic) {\LARGE {$ \frac{1}{19}$}};
\end{tikzpicture}
\end{center}



\subsection{Convertidor DC/DC}
\subsubsection*{a) Funci\'on transferencia del convertidor}

Considerando el diodo y el MOS como ideales, comenzamos analizando el espacio de estados. 

Durante el tiempo que la llave se encuentra cerrada (SW=ON) obtenemos:

\begin{equation}
\underbrace{
\begin{bmatrix}
\dot{i_{L_1}} \vspace{0.2cm} \\
\dot{V_{C_1}} 
\end{bmatrix}
}_{\dot{X}}
=
\underbrace{
\begin{bmatrix}
{0} & {0} \vspace{0.2cm}\\
{0} & {-\frac{1}{R_L \cdot C_1}} 
\end{bmatrix}
}_{A_{on}}
\underbrace{
\begin{bmatrix}
{i_{L_1}} \vspace{0.2cm}\\
{V_{C_1}} 
\end{bmatrix}
}_{X}
+
\underbrace{
\begin{bmatrix}
{\frac{1}{L_1}} \vspace{0.2cm}\\
{0} 
\end{bmatrix}
}_{B_{on}}
V_1
\end{equation}


\begin{equation}
V_o =
\underbrace{
\begin{bmatrix}
{0} & {1} 
\end{bmatrix}
}_{C_{on}}
\begin{bmatrix}
{i_{L_1}} \\
{V_{C_1}} 
\end{bmatrix}
\end{equation}

Por otro lado, durante el tiempo que la llave se encuentra abierta (SW=OFF), se obtiene que: 

\begin{equation}
A_{off} = 
\begin{bmatrix}
{0} & {- \frac{1}{L_1}} \vspace{0.3cm}\\ 
{\frac{1}{C}} & {-\frac{1}{R_L \cdot C_1}}
\end{bmatrix}  
\hspace{2cm} B_{off}=B_{on}  
\hspace{2cm} C_{off} = C_{on}
\end{equation}


A continucaci\'on se calcula el promedio ponderado de las matrices de estado:

\begin{equation}
\overline{A} = A_{on} \cdot d + A_{off} \cdot (1-d) \hspace{2cm} \overline{B}=B_{on} = B_{off}  \hspace{2cm} \overline{C}=C_{on} = C_{off}  
\end{equation}

Finalmente, utilizando la ecuaci\'on provista por la c\'atedra en la clase de Transferencias y reemplazando los valores obtenidos anteriormente obtenemos la transferencia deseada. 

\begin{equation}
\frac{ \widetilde{v_o}(s)}{\widetilde{d}(s)}= \overline{C} \cdot (s \cdot I - \overline{A})^{-1} \left[ (A_{on} - A_{off})X(s) + (B_{on} - B_{off}) V_1 \right] +(C_{on} - C_{off})X(s) 
\label{ec1.3}
\end{equation}

Donde X(s) es el vector en estado estacionario:

\begin{equation}
X(s)= 
\begin{bmatrix}
{i_{L_1}} \\
{V_{C_1}} 
\end{bmatrix}
=
\begin{bmatrix}
{\frac{I_o}{1-d}} \vspace{0.3cm} \\
{\frac{V_1}{1-d}} 
\end{bmatrix}
=
\begin{bmatrix}
{\frac{V_1}{R_L(1-d)^2}} \vspace{0.3cm} \\
{\frac{V_1}{1-d}} 
\end{bmatrix}
\end{equation}

\vspace{0.5cm}

\begin{equation}
\frac{ \widetilde{v_o}(s)}{\widetilde{d}(s)}= \frac{V_1}{(d-1)^2} \cdot
 \frac{ 1 - \frac{L_1}{R_L \cdot (d-1)^2} \cdot s}{ \frac{L_1 \cdot C_1}{(1-d)^2} \cdot s^2 +\frac{L_1}{R_L \cdot (1-d)^2 }\cdot s + 1}
\end{equation}

El sistema cuenta con dos polos complejos conjugados en el semi-plano izquierdo y un cero real en el semi-plano derecho.

\begin{equation}
z=\frac{R_L \cdot (d-1)^2}{L_1}
\end{equation}



\begin{equation}
p= - \epsilon \cdot w_n \pm j \cdot w_n \cdot \sqrt{1-{\epsilon}^2 } \hspace{1cm} \left\lbrace
\begin{array}{ll}
w_n=\sqrt{\frac{(1-d)^2}{L_1 \cdot C_1}} \vspace{0.2cm} \\
\epsilon= \frac{1}{2 \cdot w_n \cdot R_L \cdot C_1}
\end{array}
\right.
\end{equation}

  \begin{figure}[H]
  \centering
    \includegraphics[scale=0.2]{Imagenes/Punto1/rootlocus_Convertidor.jpeg}
    \caption{ Mapa de raíces del convertidor Boost}
  \end{figure}


\subsubsection*{b) Valor real del Duty cycle}

El valor real de duty cycle es $d_{real}=0.56$ mientras que el ideal es $d_{ideal}= \frac{V_o-V_1}{V_o}=0.6$.


El duty real no coincide con el ideal por el efecto de los componentes reales. Cuando aumentamos la carga, aumenta el valor medio de la corriente de la inductancia, por lo que la ca\'ida de tensi\'on en el diodo es mayor. Del mismo modo, la ca\'ida de tensi\'on en la inductancia tambi\'en aumenta. Sumado a lo anterior, tenemos los efectos de la $ESR_L$. Todo esto contribuye a que la tensi\'on de salida $V_o$ se aleje del valor deseado y el duty te\'orico no sea el requerido en la pr\'actica.


\subsubsection*{c) Tiempos de establecimiento ante los cambios de carga }

\begin{figure}[H]
  \begin{subfigure}[b]{0.3\textwidth}
    \includegraphics[width=\textwidth, height=\textwidth]{Imagenes/Punto1/Test_con_R6_1k.jpeg}
    \caption{ Con $R_6=1k\Omega$}
    \label{fig:f1}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.3\textwidth}
    \includegraphics[width=\textwidth, height=\textwidth]{Imagenes/Punto1/Test_con_R6_10k.jpeg}
    \caption{ Con $R_6=10k\Omega$}
    \label{fig:f2}
  \end{subfigure}
  \hfill
  \begin{subfigure}[b]{0.3\textwidth}
    \includegraphics[width=\textwidth, height=\textwidth]{Imagenes/Punto1/Test_con_R6_22k.jpeg}
    \caption{ Con $R_6=22k\Omega$}
    \label{fig:f3}
  \end{subfigure}
  \caption{Tiempos de establecimiento ante los cambios de carga}
\end{figure}

Los tiempos de establecimiento resultantes son: 
\hspace{0.1cm}
\begin{equation}
t_e(R_6=1k\Omega)=3.6 mseg
\hspace{1cm}
t_e(R_6=10k\Omega)=4.44 mseg
\hspace{1cm}
t_e(R_6=22k\Omega)=18.48 mseg
\end{equation}

A medida que el cero del amplificador de error se acerca al origen, el tiempo de establecimiento aumenta. En el caso de $R_6=22k\Omega$, el sistema resulta inestable. Mientras que en los otros dos casos, el sistema resulta amortiguado.  Mirando la constelación de polos, podemos llegar a las mismas conclusiones:
  \begin{figure}[H]
  \centering
    \includegraphics[scale=0.15]{Imagenes/Punto1/polos.png}
    \caption{ Constelación de polos de la transferencia a lazo cerrado}
  \end{figure}



\subsubsection*{d) Diagramas de Bode}
Una vez obtenida la ganancia a lazo cerrado del sistema, con matlab procedemos a trazar el diagrama de bode para cada valor de la resistencia, obteniendo los siguientes resultados:
  \begin{figure}[H]
  \centering
    \includegraphics[scale=0.2]{Imagenes/Punto1/bode_todos.png}
    \caption{ Diagramas de bode superpuestos}
  \end{figure}

Como podemos observar, los cambios más significativos los podemos apreciar en la fase, a medida que R se incrementa, la fase comienza a tener cambios más abruptos, hasta eventualmente tener un cambio de 180º, lo que implica que el circuito posee polos en el semiplano derecho y por ende que oscila.

\end{document}